# e2

e2 Integration

## Очереди

В e2 используются встроенные очереди:

* Очередь на конвертацию (Queue4Conversion).
* Очередь на доставку (Queue4Delivery).
* Очередь на повтор (Queue4Repeat).

Очереди используются для Update-сообщений. Эти сообщения обрабатываются асинхронно.
Очереди нужны для того, чтобы обеспечить надёжность доставки отправленных сообщений.
А также они дают возможность как можно меньше блокировать систему-отправитель,
отделяя процесс отправки исходного сообщения от конвертации и доставки
системам-получателям.

### Прохождение очередей

Каждая очередь реализована с помощью одной таблицы в базе данных сервера e2.
В одной колонке такой таблицы размещается содержание сообщения (xml-поток),
остальные колонки используются для обеспечения функционала очереди.

![](documentation/e2.%20Прохождение%20очередей.svg)

### Состояния элементов очередей

![](documentation/e2.%20Состояния%20элемента%20очереди.svg)

## Взаимодействие с сервером e2

В настоящее время взаимодействие с сервером происходит через
rest-подобный api. Все обращения должны осуществляться HTTP-методом
POST, в теле сообщения должен передаваться XML.

Основным URL для взаимодействия является `/post` (или его псевдоним
`/agr`, который исчезнет в будущих версиях). Тип сообщения определяется
на основании корневого тега из XML-содержимого сообщения. Таким образом,
для любого взаимодействия с сервером e2 можно использовать единую точку
доступа.

Кроме `/post` имеется 2 специализированных URL:

* `/request`: ожидает сообщения с тегами `listRequest` и
  `elementRequest`;
* `/update`: ожидает сообщения с тегом `updateRequest`.

Эти дополнительные URL выполняют проверку, что полученный тег
соответствует точке входа. В случае несоответствия обработка прерывается
и сервис вернёт ошибку.


## Процесс конвертации сообщения


## Как обрабатывается имя системы из сообщения

## Инициализация новой конфигурации (первое приближение)

Jar-файл конфигурации лежит в определённом месте (пока не в базе). При
запуске сервера стартует бин `ConfigurationManager`. Его метод
`afterPropertiesSet()` запускает метод `updateConfiguration`, отвечающий
за инициализацию конфигурации.

Создаётся новый класс-лоадер, которому передаётся путь к jar-файлу
конфигурации. Выполняется создание нового экземпляра `Configuration4E2`.

В конце процесса новый экземпляр конфигурации заменяет старый, новые
процессы теперь будут получать его.

## Запрос данных

Запрос данных нужен для того, чтобы одна из систем могла запросить текущие
данные каких-либо сущностей у других систем. Сама запрашивающая система не должна
при этом знать, у каких систем она будет запрашивать данные, как и не должна
знать что-либо об устройстве данных в запрашиваемых системах. Запрос должен
формироваться в понятиях (метаданных) запрашивающей системы. Всё остальное
должен будет сделать сервер e2, когда получит этот запрос.

### Структура запрашивающего сообщения

Для запроса данных система формирует *запращивающее сообщение*. Такое сообщение
может содержать сразу много запросов. В каждом отдельном запросе обязательно
декларируется, какая именно сущность запрашивается (то есть, элементы какой
сущности ожидаются в качестве результата). В одном сообщении может быть как
множество запросов к разным сущностям, так и множество запросов к одной и той
же сущности (например, с разными условиями фильтрации). Результаты всех
запросов будут объединены в одном ответном сообщении.

Декларирование результирующей сущности в запросе необходимо по нескольким
причинам. Первая причина - маршрутизация. Запрашивающие сообщения
маршрутизируются по тому же принципу, что и сообщения с обновлениями. То есть
на основании системы отправителя и названий запрашиваемых сущностей. Отличие
только в том, что для запросов используется отдельная таблица маршрутов.

Основная же причина указывать запрашиваемую сущность - концептуальная. Назначением
e2 является именно обмен сущностями между системами. Поэтому естественным квантом
обмена является именно элемент сущности. Поэтому, в отличие от, например, sql
запросы в e2 не позволяют возвращать конкретные поля сущностей, или делать какие-либо
агрегации. И в будущем такие фунции не планируются.

Считаю, что если прикладной системе нужна аналитическая функциональность, она должна
обеспечивать её сама. В системе интеграции это не нужно, тут нужно стремиться к
простоте, ведь интеграция и так явление сложное. Если же возникнут какие-то особые
случаи, которые не могут быть покрыты имеющимся функционалом e2, наверняка их будет
не слишком много, и можно будет найти для них индивидуальное решение. Благо в том,
чтобы массовая часть интеграций была решена системным, типовым образом.

Повторю ещё раз, что целью и результатом запроса e2 является получение
запрашивающей системой сообщения, содежащего текущее состояние элементов
некоторых сущностей, по структуре это сообщение подобно сообщению с обновлением.

Структура же самих запросов не должна быть слишком мощной и сложной. Надо помнить,
что запрос должен быть сконвертирован в понятия запрашиваемых систем. Если его
структура будет слишком сложной, это приведёт к усложнению конверсий, может
чаще вызывать отказы конверсий. В кончном итоге будет отталкивать от использования
системы.


### Структура ответного сообщения 

Как уже было сказано, ответное сообщение по структуре подобно сообщению с
обновлением. Отличие в том, что в общем случае оно похоже на сразу несколько
сообщений с обновлением. Ведь в зависимости от маршрутов, могли быть запрошены
сразу несколько систем. Поэтому, в сообщении ответа на верхнем уровне будут
узлы, соответствующие ответившим системам, а уже внутри каждого такого узла
будет сообщение обновления, содержащее результат запроса к соответствующей
системе.

Вместо сообщений обновления внутри узлов запрошенных систем могут оказаться узлы
ошибок, если что-то пошло не так при попытке обработать запрос. Иногда может
оказаться, что запрос какой-то сущности не удаётся сконвертировать (то есть,
ошибка возникает уже на этапе конвертации запроса, ещё до отправки в запрашиваемую
систему). Это может произойти в силу больших различий в метаданных двух систем,
либо если не хватает нужных конверсий. Это ещё один вид ошибки, который может
прийти в ответном сообщении.

### Процесс прохождения запрашивающего сообщения

Одно запрашивающее сообщение может быть направлено в несколько систем, при этом
часть сущностей пойдут в одни системы, часть в другие, а некоторые одновременно
в несколько. При этом происходит конвертация запросов в понятия запрашиваемых
систем специальными конверсиями для запросов.

Конвертация ответов осуществляется обычнми конверсиями. Маршрутизация при этом
никакая не применяется.
